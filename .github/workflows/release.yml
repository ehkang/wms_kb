name: Build Windows App

on:
  push:
    branches: [ master, main ]
    tags:
      - '*'  # 推送任何 tag 时触发
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:  # 允许手动触发
    inputs:
      create_release:
        description: '是否创建 GitHub Release'
        required: false
        type: boolean
        default: false

# 明确声明需要的权限
permissions:
  contents: write  # 创建 Release 和上传资源

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
    - name: 检出代码
      uses: actions/checkout@v4

    - name: 提取版本号
      id: version
      shell: pwsh
      run: |
        # 检查是否是 tag 触发
        $gitRef = "${{ github.ref }}"

        if ($gitRef -match '^refs/tags/(.+)$') {
            # Tag 触发：直接使用完整的 tag 名称作为版本号
            $version = $matches[1]
            Write-Host "✓ 使用 Git Tag 作为版本号: $version"
        } else {
            # 非 Tag 触发：从 package.json 读取
            $packageJson = Get-Content package.json -Raw | ConvertFrom-Json
            $version = $packageJson.version
            Write-Host "✓ 使用 package.json 版本号: $version"
        }

        echo "APP_VERSION=$version" >> $env:GITHUB_ENV
        echo "RELEASE_VERSION=$version" >> $env:GITHUB_ENV
        echo "version=$version" >> $env:GITHUB_OUTPUT
        Write-Host "✓ 发布版本号: $version"

    - name: 设置 Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20

    - name: 安装 pnpm
      uses: pnpm/action-setup@v3
      with:
        version: 8

    - name: 获取 pnpm store 目录
      shell: pwsh
      run: |
        $storePath = pnpm store path --silent
        echo "STORE_PATH=$storePath" >> $env:GITHUB_ENV

    - name: 缓存 pnpm 依赖
      uses: actions/cache@v4
      with:
        path: ${{ env.STORE_PATH }}
        key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
        restore-keys: |
          ${{ runner.os }}-pnpm-store-

    - name: 安装依赖
      run: pnpm install --no-frozen-lockfile

    - name: 构建 Windows 安装包
      run: pnpm run build:win
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: 查找生成的安装包
      id: find_installer
      shell: pwsh
      run: |
        $setupFile = Get-ChildItem -Path dist -Filter "wms_kb-*-setup.exe" | Select-Object -First 1
        if (-not $setupFile) {
            Write-Error "未找到安装包文件"
            exit 1
        }
        $setupFileName = $setupFile.Name
        echo "SETUP_FILE=$setupFileName" >> $env:GITHUB_ENV
        Write-Host "✓ 找到安装包: $setupFileName"
        Write-Host "文件大小: $($setupFile.Length / 1MB) MB"

    - name: 上传编译产物
      uses: actions/upload-artifact@v4
      with:
        name: wms_kb_v${{ env.RELEASE_VERSION }}_windows_x64
        path: dist/${{ env.SETUP_FILE }}
        retention-days: 30

    # 只在推送 tag 时创建 Release
    - name: 创建 GitHub Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v2
      with:
        files: dist/${{ env.SETUP_FILE }}
        tag_name: ${{ github.ref_name }}
        name: WMS看板系统 ${{ env.RELEASE_VERSION }}
        body: |
          ## 下载
          - **Windows x64 安装包**: ${{ env.SETUP_FILE }}

          ## 功能特性
          - ✅ 自动全屏显示
          - ✅ 开机自动启动（仅生产环境）
          - ✅ 单站台/双站台监控模式
          - ✅ 实时 SignalR 数据推送
          - ✅ 3D 模型查看器

          ## 版本信息
          - 版本: ${{ env.RELEASE_VERSION }}
          - 构建时间: ${{ github.event.head_commit.timestamp || 'N/A' }}
          - 提交: ${{ github.sha }}

          ## 安装说明
          1. 下载 `${{ env.SETUP_FILE }}`
          2. 双击运行安装程序
          3. 安装完成后自动启动应用
          4. 应用将自动设置为开机启动

          ## 系统要求
          - Windows 10/11 (64位)
          - 需要联网（连接 WMS/WCS 系统）
        draft: false
        prerelease: ${{ contains(github.ref_name, 'beta') || contains(github.ref_name, 'alpha') || contains(github.ref_name, 'rc') }}
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
